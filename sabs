#!/bin/sh

source ~/.config/sabs.conf
cd ~/.abs-pkg

abs_root() {
	$SABS_SUDO $@
}

log() {
	echo -e "\e[1;34m::\e[0m" $@
}

usage() {
	echo "Usage: sabs <build|ebd|ebb>"
}

gen_patch() {
	backup=$(mktemp -d ~/.cache/abs-pkg/abs.XXXXXX)

	touch $1
	patch -p < $1
	cp -R git/* $backup

	log "Opening shell..."

	export PS1="(sabs) $PS1"
	bash

	diff -r $backup git > "$1"
	log "Generating patch..."

	rm -rf $backup
}

case $1 in
	"build")
		log "Building $2..."
		cd ~/.abs-pkg/$2

		if [[ -z $1 ]]
		then
			echo "Usage: sabs build <package>"
		fi

		pwd
		cd git
		makepkg -os
		;;
	"ebd")
		log "Generating pre install patch"

		mkdir sabs &> /dev/null
		gen_patch sabs/predownload.patch
		;;
	"ebb")
		log "Generating pre build patch"

		mkdir sabs &> /dev/null
		gen_patch sabs/prebuild.patch
		;;
	*)
		usage
		;;
esac
